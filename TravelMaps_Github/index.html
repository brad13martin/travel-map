<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Didius Travel Map</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.js"></script>
<style>
  html,body{height:100%;margin:0;font-family:system-ui,Inter,Arial}
  #map{height:100vh;width:100%}
  .filterbar{position:absolute;z-index:2;top:12px;left:12px;background:#fff;padding:8px 10px;border-radius:10px;border:1px solid #e5e7eb;box-shadow:0 6px 20px rgba(0,0,0,.12)}
  .filterbar select,.filterbar input{margin-right:6px}
  .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
</style>
</head>
<body>

<div class="filterbar">
  <select id="typeFilter"><option value="">All types</option></select>
  <select id="stateFilter"><option value="">All states</option></select>
  <input id="tagSearch" placeholder="Filter tags (e.g., seafood)">
  <span class="badge">Tip: click a marker for details</span>
</div>

<div id="map" aria-label="Interactive map of your places"></div>

<script>
// Credentials & map config
mapboxgl.accessToken = 'pk.eyJ1IjoiYnJhZDEzbWFydGluIiwiYSI6ImNta2p6eHI5MzE4YzAzY282aXE4Mjhxc3QifQ.tkosuQGdRkfSMoRVWCakbg';
const STYLE_URL   = 'mapbox://styles/brad13martin/cmkjztnvs001u01qm6lsmeold';

// Your dataset (explicit)
const TILESET_URL = 'mapbox://brad13martin.c1m5hzkh';
const SOURCE_LAYER = 'travelmap_geocoded-5lk8ms';

// IDs we add
const DATA_SOURCE_ID = 'places';
const DATA_LAYER_ID  = 'places-points';

const map = new mapboxgl.Map({
  container: 'map',
  style: STYLE_URL,
  center: [-80, 40],
  zoom: 5
});

map.addControl(new mapboxgl.NavigationControl());
map.scrollZoom.disable();
map.on('click', () => map.scrollZoom.enable(), { once: true });

map.on('load', () => {
  // 1) Add your vector tileset as a source
  map.addSource(DATA_SOURCE_ID, { type: 'vector', url: TILESET_URL });

  // 2) Add a circle layer from that source
  map.addLayer({
    id: DATA_LAYER_ID,
    type: 'circle',
    source: DATA_SOURCE_ID,
    'source-layer': SOURCE_LAYER,
    paint: {
      'circle-radius': 6,
      'circle-color': '#2563eb',
      'circle-stroke-color': '#fff',
      'circle-stroke-width': 1
    }
  });

  // 3) Build dropdowns from data
  buildFilters();

  // 4) Popups (wired to your headers)
  map.on('click', DATA_LAYER_ID, e => {
    const p = e.features[0].properties || {};
    const ll = e.features[0].geometry.coordinates;
    const safe = k => (p[k] ? String(p[k]) : '');

    const lines = [
      `<strong>${safe('Name') || 'Place'}</strong>`,
      safe('Type') && `<div><em>${safe('Type')}</em></div>`,
      safe('Restaurant Rating') && `Rating: ${safe('Restaurant Rating')}`,
      safe('Lobster Roll Ranking') && `Lobster Roll Ranking: ${safe('Lobster Roll Ranking')}`,
      safe('Activity / Accommodations Rating') && `Activity/Accommodations: ${safe('Activity / Accommodations Rating')}`,
      (safe('Trail Length') || safe('Difficulty') || safe('Est. Time') || safe('Loop')) &&
        `<div style="margin-top:6px">
           ${safe('Trail Length') ? `Trail: ${safe('Trail Length')}` : ''} 
           ${safe('Difficulty') ? ` · ${safe('Difficulty')}` : ''} 
           ${safe('Est. Time') ? ` · ${safe('Est. Time')}` : ''} 
           ${safe('Loop') ? ` · Loop: ${safe('Loop')}` : ''}
         </div>`,
      (safe('City') || safe('State')) && `${safe('City')}${safe('City')&&safe('State')?', ':''}${safe('State')}`,
      safe('Tags') && `<div>Tags: ${safe('Tags')}</div>`,
      safe('Notes') && `<div style="margin-top:6px">${safe('Notes')}</div>`,
      safe('URL') && `<div style="margin-top:6px"><a href="${safe('URL')}" target="_blank" rel="noopener">Open link</a></div>`
    ].filter(Boolean);

    new mapboxgl.Popup().setLngLat(ll).setHTML(lines.join('<br>')).addTo(map);
  });

  map.on('mouseenter', DATA_LAYER_ID, () => map.getCanvas().style.cursor = 'pointer');
  map.on('mouseleave', DATA_LAYER_ID, () => map.getCanvas().style.cursor = '');

  // 5) Hook up filters
  document.getElementById('typeFilter').addEventListener('change', applyFilters);
  document.getElementById('stateFilter').addEventListener('change', applyFilters);
  document.getElementById('tagSearch').addEventListener('input', debounce(applyFilters, 250));
});

function applyFilters() {
  const typeVal  = (document.getElementById('typeFilter').value || '').toLowerCase();
  const stateVal = (document.getElementById('stateFilter').value || '').toLowerCase();
  const tagVal   = (document.getElementById('tagSearch').value || '').toLowerCase();

  const conditions = ['all'];
  if (typeVal)  conditions.push(['==', ['downcase', ['get', 'Type']],  typeVal]);
  if (stateVal) conditions.push(['==', ['downcase', ['get', 'State']], stateVal]);
  if (tagVal)   conditions.push(['in', tagVal, ['downcase', ['get', 'Tags']]]);

  if (map.getLayer(DATA_LAYER_ID)) map.setFilter(DATA_LAYER_ID, conditions);
}

function buildFilters() {
  const types = new Set();
  const states = new Set();

  let feats = [];
  try {
    feats = map.querySourceFeatures(DATA_SOURCE_ID, { sourceLayer: SOURCE_LAYER }) || [];
  } catch (e) {}

  feats.forEach(f => {
    const p = f.properties || {};
    if (p['Type'])  types.add(String(p['Type']));
    if (p['State']) states.add(String(p['State']));
  });

  const typeSel = document.getElementById('typeFilter');
  const stateSel = document.getElementById('stateFilter');

  [...types].sort().forEach(v => {
    const opt = document.createElement('option'); opt.value = v; opt.textContent = v;
    typeSel.appendChild(opt);
  });
  [...states].sort().forEach(v => {
    const opt = document.createElement('option'); opt.value = v; opt.textContent = v;
    stateSel.appendChild(opt);
  });
}

function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
</script>
</body>
</html>
