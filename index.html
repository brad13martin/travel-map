<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Didius Travel Map</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.js"></script>
<style>
  html,body{height:100%;margin:0;font-family:system-ui,Inter,Arial}
  #map{height:100vh;width:100%}
  .filterbar{position:absolute;z-index:2;top:12px;left:12px;background:#fff;padding:8px 10px;border-radius:10px;border:1px solid #e5e7eb;box-shadow:0 6px 20px rgba(0,0,0,.12)}
  .filterbar select,.filterbar input{margin-right:6px}
  .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
</style>
</head>
<body>

<div class="filterbar">
  <select id="typeFilter"><option value="">All types</option></select>
  <select id="stateFilter"><option value="">All states</option></select>
  <input id="tagSearch" placeholder="Filter tags (e.g., seafood)">
  <span class="badge">Tip: click a marker for details</span>
</div>

<div id="map" aria-label="Interactive map of your places"></div>

<script>
// 1) Your token + style (from your message)
mapboxgl.accessToken = 'pk.eyJ1IjoiYnJhZDEzbWFydGluIiwiYSI6ImNta2p6eHI5MzE4YzAzY282aXE4Mjhxc3QifQ.tkosuQGdRkfSMoRVWCakbg';
const STYLE_URL = 'mapbox://styles/brad13martin/cmkjztnvs001u01qm6lsmeold';

// 2) Spin up the map
const map = new mapboxgl.Map({
  container: 'map',
  style: STYLE_URL,
  center: [-80, 40],
  zoom: 5
});
map.addControl(new mapboxgl.NavigationControl());
map.scrollZoom.disable();
map.on('click', () => map.scrollZoom.enable(), { once: true });

// 3) We’ll auto-detect your data layer inside the style
let TARGET_LAYER_ID = null;     // e.g., 'places-points' inside your style
let TARGET_SOURCE_ID = null;    // the style's source name for that layer
let TARGET_SOURCE_LAYER = null; // the vector 'source-layer' (tileset layer name)

map.on('load', () => {
  // Find the first circle/symbol layer that has features with your expected fields
  const layers = map.getStyle().layers || [];
  const candidateLayers = layers.filter(l =>
    (l.type === 'circle' || l.type === 'symbol') &&
    l.source &&
    // either vector with source-layer or geojson source
    (map.getSource(l.source)?.type === 'vector' || map.getSource(l.source)?.type === 'geojson')
  );

  // Try each candidate: if we can read a feature with "Name" or "Lat" property, assume it's your dataset
  (function pickLayer(i=0) {
    if (i >= candidateLayers.length) {
      alert('Could not auto-detect the data layer from the style. If needed, tell me the layer id or tileset, and I’ll hard-wire it.');
      return;
    }
    const L = candidateLayers[i];
    try {
      // Prefer querying source features (works even if not currently visible)
      const feats = map.querySourceFeatures(L.source, L['source-layer'] ? {sourceLayer: L['source-layer']} : {});
      const probe = feats.find(f => {
        const p = f.properties || {};
        return p['Name'] || p['Lat'] || p['Long'] || p['City'] || p['State'];
      });

      if (probe) {
        TARGET_LAYER_ID = L.id;
        TARGET_SOURCE_ID = L.source;
        TARGET_SOURCE_LAYER = L['source-layer'] || null;
        wireInteractions();
        buildFilters();
      } else {
        pickLayer(i+1);
      }
    } catch(e) {
      // Some sources may not be queryable at this moment; try next
      pickLayer(i+1);
    }
  })();
});

// 4) Popups, cursor, and filtering
function wireInteractions() {
  // Cursor change
  map.on('mouseenter', TARGET_LAYER_ID, () => map.getCanvas().style.cursor = 'pointer');
  map.on('mouseleave', TARGET_LAYER_ID, () => map.getCanvas().style.cursor = '');

  // Popups on click
  map.on('click', TARGET_LAYER_ID, e => {
    const p = e.features[0].properties || {};
    const ll = e.features[0].geometry.coordinates;

    const safe = k => (p[k] ? String(p[k]) : '');

    const lines = [
      `<strong>${safe('Name') || 'Place'}</strong>`,
      safe('Type') && `<div><em>${safe('Type')}</em></div>`,
      safe('Restaurant Rating') && `Rating: ${safe('Restaurant Rating')}`,
      safe('Lobster Roll Ranking') && `Lobster Roll Ranking: ${safe('Lobster Roll Ranking')}`,
      safe('Activity / Accommodations Rating') && `Activity/Accommodations: ${safe('Activity / Accommodations Rating')}`,
      (safe('Trail Length') || safe('Difficulty') || safe('Est. Time') || safe('Loop')) &&
        `<div style="margin-top:6px">
           ${safe('Trail Length') ? `Trail: ${safe('Trail Length')}` : ''} 
           ${safe('Difficulty') ? ` · ${safe('Difficulty')}` : ''} 
           ${safe('Est. Time') ? ` · ${safe('Est. Time')}` : ''} 
           ${safe('Loop') ? ` · Loop: ${safe('Loop')}` : ''}
         </div>`,
      (safe('City') || safe('State')) && `${safe('City')}${safe('City')&&safe('State')?', ':''}${safe('State')}`,
      safe('Tags') && `<div>Tags: ${safe('Tags')}</div>`,
      safe('Notes') && `<div style="margin-top:6px">${safe('Notes')}</div>`,
      safe('URL') && `<div style="margin-top:6px"><a href="${safe('URL')}" target="_blank" rel="noopener">Open link</a></div>`
    ].filter(Boolean);

    new mapboxgl.Popup().setLngLat(ll).setHTML(lines.join('<br>')).addTo(map);
  });

  // Hook up filter controls
  document.getElementById('typeFilter').addEventListener('change', applyFilters);
  document.getElementById('stateFilter').addEventListener('change', applyFilters);
  document.getElementById('tagSearch').addEventListener('input', debounce(applyFilters, 250));
}

function applyFilters() {
  if (!TARGET_LAYER_ID) return;

  const typeVal  = (document.getElementById('typeFilter').value || '').toLowerCase();
  const stateVal = (document.getElementById('stateFilter').value || '').toLowerCase();
  const tagVal   = (document.getElementById('tagSearch').value || '').toLowerCase();

  const conditions = ['all'];
  if (typeVal)  conditions.push(['==', ['downcase', ['get', 'Type']],  typeVal]);
  if (stateVal) conditions.push(['==', ['downcase', ['get', 'State']], stateVal]);
  if (tagVal)   conditions.push(['in', tagVal, ['downcase', ['get', 'Tags']]]);

  map.setFilter(TARGET_LAYER_ID, conditions);
}

function buildFilters() {
  if (!TARGET_SOURCE_ID) return;

  const typeSet = new Set();
  const stateSet = new Set();

  let feats = [];
  try {
    feats = map.querySourceFeatures(TARGET_SOURCE_ID, TARGET_SOURCE_LAYER ? {sourceLayer: TARGET_SOURCE_LAYER} : {});
  } catch (e) {}

  feats.forEach(f => {
    const p = f.properties || {};
    if (p['Type'])  typeSet.add(String(p['Type']));
    if (p['State']) stateSet.add(String(p['State']));
  });

  const typeSel = document.getElementById('typeFilter');
  const stateSel = document.getElementById('stateFilter');

  [...typeSet].sort().forEach(v => {
    const opt = document.createElement('option'); opt.value = v; opt.textContent = v;
    typeSel.appendChild(opt);
  });
  [...stateSet].sort().forEach(v => {
    const opt = document.createElement('option'); opt.value = v; opt.textContent = v;
    stateSel.appendChild(opt);
  });
}

// tiny debounce helper
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
</script>
</body>
</html>
