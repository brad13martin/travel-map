<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Didius Travel Map â€” Separate Search Box (Visible)</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.css" rel="stylesheet" />
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.3.1/mapbox-gl-directions.css" rel="stylesheet" />
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css" rel="stylesheet" />

<style>
  html,body{height:100%;margin:0;font-family:system-ui,Inter,Arial}
  #map{height:100vh;width:100%}

  /* Move panel down so it doesn't overlap the geocoder box */
  .panel{
    position:absolute;z-index:4;left:12px;top:90px;  /* <- was 12px; now 90px */
    background:#fff;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;
    box-shadow:0 6px 20px rgba(0,0,0,.12);
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;max-width:420px
  }
  .panel label{font-size:12px;color:#111827}
  .panel input[type="range"]{width:150px}
  .pill{border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px;font-size:12px;background:#f8fafc;cursor:pointer}
  .sep{width:1px;height:26px;background:#e5e7eb;display:inline-block;margin:0 2px}

  /* Make Mapbox controls sit above the panel */
  .mapboxgl-ctrl         { z-index:7 }
  .mapboxgl-ctrl-top-left{ margin:12px }   /* Geocoder (Single point) */
  .mapboxgl-ctrl-top-right{ margin:12px }  /* Directions (Route) */
  .mapboxgl-ctrl-bottom-right{ margin:12px }
  .mapboxgl-ctrl-geocoder{ min-width:320px;font-size:12px }
  .mapboxgl-ctrl-directions{ max-width:420px }

  /* Legend bottom-left so it never covers controls */
  #legend{
    position:absolute;left:12px;bottom:12px;background:#fff;border:1px solid #e5e7eb;
    border-radius:12px;padding:8px 10px;box-shadow:0 6px 20px rgba(0,0,0,.12);z-index:2
  }
  #err{
    position:absolute;left:12px;top:12px;background:#fff;border:1px solid #e5e7eb;
    border-radius:10px;padding:8px 10px;box-shadow:0 6px 20px rgba(0,0,0,.12);
    font-size:12px;max-width:70ch;display:none;z-index:8;white-space:pre-wrap
  }
  #dbg{
    position:absolute;right:12px;bottom:12px;background:#fff;border:1px solid #e5e7eb;
    border-radius:10px;padding:6px 8px;font-size:12px;z-index:4
  }
  button:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body>

<!-- Compact settings panel (no search inside) -->
<div class="panel">
  <span class="pill">
    Mode:
    <label style="margin-left:6px"><input type="radio" name="uxmode" value="point" checked> Single point</label>
    <label><input type="radio" name="uxmode" value="route"> Route</label>
  </span>

  <span class="sep"></span>

  <span class="pill" style="background:#fff">
    Within <input id="mins" type="range" min="5" max="120" step="5" value="15" />
    <strong><span id="minsVal">15</span> min</strong>
  </span>

  <span class="pill" style="background:#fff">
    Travel:
    <label><input type="radio" name="mode" value="driving" checked> Driving</label>
    <label><input type="radio" name="mode" value="walking"> Walking</label>
    <label><input type="radio" name="mode" value="cycling"> Cycling</label>
  </span>

  <button id="applyBtn" class="pill" disabled>Apply</button>
  <button id="clearIso" class="pill">Clear</button>

  <label class="pill" style="background:#fff">
    <input id="fitToggle" type="checkbox" />
    Fit view to area
  </label>
</div>

<div id="map" aria-label="Interactive map"></div>
<div id="legend"></div>
<div id="err"></div>
<div id="dbg">Visible points: <span id="visCount">0</span></div>

<!-- Core libs -->
<script src="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.js"></script>

<!-- Plugins -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.3.1/mapbox-gl-directions.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js"></script>

<!-- Fallbacks if CDN fails -->
<script>
(function ensurePlugins(){
  function add(src){ var s=document.createElement('script'); s.src=src; s.defer=false; s.async=false; document.body.appendChild(s); }
  if (typeof MapboxDirections === 'undefined') add('https://unpkg.com/@mapbox/mapbox-gl-directions@4.3.1/dist/mapbox-gl-directions.js');
  if (typeof MapboxGeocoder === 'undefined')  add('https://unpkg.com/@mapbox/mapbox-gl-geocoder@5.0.1/dist/mapbox-gl-geocoder.min.js');
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
(async function(){
  // Wait for plugins to exist
  function waitFor(cond, timeout=6000){
    const t0=Date.now();
    return new Promise((res,rej)=>{(function tick(){ if(cond()) return res(); if(Date.now()-t0>timeout) return rej(new Error('Plugin load timeout')); requestAnimationFrame(tick); })();});
  }
  try { await waitFor(()=> window.mapboxgl && window.MapboxDirections && window.MapboxGeocoder); } catch(e){ console.error(e); alert('Mapbox plugins failed to load.'); return; }

  // ===== CONFIG =====
  mapboxgl.accessToken = 'pk.eyJ1IjoiYnJhZDEzbWFydGluIiwiYSI6ImNta2p6eHI5MzE4YzAzY282aXE4Mjhxc3QifQ.tkosuQGdRkfSMoRVWCakbg';
  const STYLE_URL = 'mapbox://styles/brad13martin/cmkjztnvs001u01qm6lsmeold';
  const GEO_PATH  = '/travel-map/data/places.geojson';

  const GEO_SOURCE_ID='places-geo', GEO_LAYER_ID='places-geo-points';
  const ISO_SOURCE_ID='iso-source', ISO_LAYER_FILL='iso-fill', ISO_LAYER_LINE='iso-line';

  // ===== MAP =====
  const map=new mapboxgl.Map({ container:'map', style:STYLE_URL, center:[-80,40], zoom:5 });
  map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

  // Geocoder: its own box, top-left
  const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken, mapboxgl, marker:false,
    placeholder:'Search a place (Single point)', proximity:{ longitude:-80, latitude:40 }
  });
  map.addControl(geocoder, 'top-left');

  // Directions: its own box, top-right
  const directions=new MapboxDirections({
    accessToken: mapboxgl.accessToken, profile:'mapbox/driving', unit:'imperial',
    alternatives:true, controls:{ instructions:true, inputs:true, profileSwitcher:true },
    interactive:false, draggable:false, geometries:'geojson'
  });
  map.addControl(directions, 'top-right');

  // Wait until the geocoder and directions DOM are present, then toggle
  function geocoderEl(){ return document.querySelector('.mapboxgl-ctrl-top-left .mapboxgl-ctrl-geocoder'); }
  function directionsEl(){ return document.querySelector('.mapboxgl-ctrl-top-right .mapboxgl-ctrl-directions'); }
  function currentUXMode(){ return (document.querySelector('input[name="uxmode"]:checked')?.value) || 'point'; }
  function setControlVisibility(){
    const ux=currentUXMode(), g=geocoderEl(), d=directionsEl();
    if (g) g.style.display = (ux==='point') ? 'block' : 'none';
    if (d) d.style.display = (ux==='route') ? 'block' : 'none';
  }
  // Poll for the controls once to ensure we catch slow network
  let tries=0; const iv=setInterval(()=>{ setControlVisibility(); if((geocoderEl()||directionsEl()) && ++tries>5) clearInterval(iv); }, 200);
  // And re-run on mode change
  document.querySelectorAll('input[name="uxmode"]').forEach(r=> r.addEventListener('change', setControlVisibility));
  // Initial
  setControlVisibility();

  // ... keep the rest of your app code (data loading, isochrone/corridor, etc.) unchanged ...
})();
</script>
</body>
</html>
